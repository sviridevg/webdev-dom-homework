<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div id="bodyContainer" class="container">
      <ul id="comments" class="comments">
        <!-- Коменты рендерятся из JS -->
      </ul>
      <p class="hide" id="commentPreload">Комментарий отправляется...</p>
      <div id="form" class="add-form">
        <input
          id="inputName"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя" />
        <textarea
          id="inputText"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"></textarea>
        <div class="add-form-row">
          <button id="add-form-button" class="add-form-button">Написать</button>
        </div>
        <button id="dell" class="manipulation-of-comments">
          Удалить послений комментарий
        </button>
      </div>
    </div>
  </body>

  <script>
    const buttonEl = document.getElementById("add-form-button");
    const commentsEl = document.getElementById("comments");
    const inputNameEl = document.getElementById("inputName");
    const inputTextEl = document.getElementById("inputText");
    const dellbutton = document.getElementById("dell");
    const baseURL = "https://wedev-api.sky.pro/api/v1/sviridevg/comments";
    const formEl = document.getElementById("form");
    const commentPreloadEl = document.getElementById("commentPreload");
    const bodyContainerEl = document.getElementById("bodyContainer");

    // Прелоадер страницы комментариев
    commentsEl.disabled = true;
    commentsEl.textContent = "Пожалуйста подождите комментарии загружаются";

    // Получение данных с сервера v2.0
    const getFetchPromise = () => {
      fetch(baseURL, {
        method: "GET",
      })
        .then((response) => {
          return response.json();
        })
        .then((responseData) => {
          commentsForRender = responseData.comments;
          renderComments();
        });
    };
    getFetchPromise();

    // Функция рендера
    const renderComments = () => {
      const commentsHtml = commentsForRender
        .map((post, index) => {
          // функция отображения даты
          const getDate = () => {
            const currentDate = new Date(post.date);
            let day = currentDate.getDate();
            let trueDay = day < 10 ? "0" + day : day;
            let month = currentDate.getMonth() + 1;
            let trueMonth = month < 10 ? "0" + month : month;
            let year = currentDate.getFullYear().toString().substr(-2);
            let dateEl = `${trueDay}:${trueMonth}:${year}`;
            let currentHourse =
              currentDate.getHours() < 10
                ? "0" + currentDate.getHours()
                : currentDate.getHours();
            let currentMinutes =
              currentDate.getMinutes() < 10
                ? "0" + currentDate.getMinutes()
                : currentDate.getMinutes();
            let currentTime = `${currentHourse}:${currentMinutes} `;
            let currentDateTime = `${dateEl} ${currentTime}`;
            return currentDateTime;
          };

          // Условия изменения стилие сердечка и открытия окна редактирования
          const isLike = post.isLiked ? "-active-like" : "";
          const isEdit = post.isEdit ? "" : "hide";
          const isAuthor = post.isAuthor ? "" : "hide";

          // Верстка тела комментария
          return `<li class="comment" >
                <div class="comment-header">
                  <div> ${post.author.name} </div>
                  <div>${getDate()}</div>
                </div>
                <div class="comment-body">
                  <div id=${post.id} class="comment-text">
                    ${post.text}
                  </div>
                </div>
                <div class="comment-footer">
                  <div class="likes">
                    <span id = "likes-counter" class="likes-counter">${
                      post.likes
                    }</span>
                    <button id=${index} class="like-button ${isLike}"></button>
                  </div>

                </div>
                <div class="${isEdit}">
                  <div class="edit-form">
                    <input id='inpt_${index}' type="text" class="add-form-text"/>
                    <div class="add-form-row">
                      <button id='btn_${index}' class="add-form-button">Сохранить</button>
                    </div>
                  </div>
                </div>
                <button id=${index} class="manipulation-of-comments ${isAuthor}">Редактировать</button>
                </li>`;
        })
        .join("");

      commentsEl.innerHTML = commentsHtml;
      handleButtonClick()
    };

    // Функция для имитации запросов в API
    function delay(interval = 300) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve();
        }, interval);
      });
    }

    // Работаем с количеством лайков с имитайцией запросов в API
    commentsEl.addEventListener("click", function (e) {
      if (e.target.className.includes("like-button")) {
        // Выбрал необходимое сердечко и добавил на него стиль с анимацией
        e.target.classList.value = "like-button -loading";
        // В этот же момент добавил для Body стиль курсора с прогрессом загрузки
        bodyContainerEl.classList.value = "container progress-cursor";
        // Запустилась функция имитации запросов в API
        delay(2000).then(() => {
          let index = Number(e.target.id);
          const currentPost = commentsForRender[index];
          let currentComment = currentPost.isLiked;
          let currentCounterLike = currentPost.likes;
          currentComment = !currentComment;
          if (currentComment) {
            currentCounterLike = currentCounterLike + 1;
          } else {
            currentCounterLike = currentCounterLike - 1;
          }

          currentPost.isLiked = currentComment;
          currentPost.likes = currentCounterLike;
          renderComments();
          // По завершению рендера убираю у Body стиль курсора
          bodyContainerEl.classList.value = "container";
        });
      }
    });

    // Забираем комментарий для ответа на него
    commentsEl.addEventListener("click", function (e) {
      if (e.target.className.includes("comment-text")) {
        let i = Number(e.target.id);
        const currentPostText = commentsForRender.find((el) => el.id === i);

        // Если dTransfer >= 0 значит есть перенос строки с последнего элемента \n (Репост репоста)
        const idTransfer = currentPostText.text.lastIndexOf("\n");
        let currentCommentText;
        if (idTransfer >= 0) {
          const lastComment = currentPostText.text.slice(idTransfer);
          currentCommentText = lastComment;
        } else {
          currentCommentText = currentPostText.text;
        }

        let currentCommentAuthor = currentPostText.author.name;
        inputTextEl.value = `QUOTE_BEGIN > "${currentCommentAuthor}" \n ${currentCommentText} QUOTE_END \n `;
      }
    });

    // Редактирование комментария
    commentsEl.addEventListener("click", function (e) {
      if (e.target.className.includes("manipulation-of-comments")) {
        let i = Number(e.target.id);
        const editCurrentPost = commentsForRender[i];
        editCurrentPost.isEdit = !editCurrentPost.isEdit;
        renderComments();
        const editInput = document.getElementById(`inpt_${i}`);
        editInput.defaultValue = editCurrentPost.comment;
      }
    });

    // Сохранение измененного комментария
    commentsEl.addEventListener("click", function (e) {
      if (e.target.className.includes("add-form-button")) {
        let { id } = e.target;
        let i = Number(id.slice(4));
        const editInputValue = document.getElementById(`inpt_${i}`).value;
        commentsForRender[i].comment = editInputValue;
        commentsForRender[i].isEdit = false;
        renderComments();
      }
    });

    // Проверка на наличия текста в в форме
    function error(a) {
      if (a.value === "") {
        a.classList.add("error");
        buttonEl.classList.add("error");
        return true;
      }
      return false;
    }

    // Функция добавления нового комментария
    buttonEl.addEventListener("click", function (e) {
      const oldCommentsEl = commentsEl.innerHTML;
      inputNameEl.classList.remove("error");
      inputTextEl.classList.remove("error");
      buttonEl.classList.remove("error");
      const nameError = error(inputNameEl);
      const textError = error(inputTextEl);
      sendData();

      if (nameError || textError) {
        return;
      }

      // Прелоадер отправки комментария
      // Создал новый элемент формы при нажатии на кнопку "Написать" на форму добавляю стиль Hide который убирает форму
      formEl.classList.value = "hide";
      // Создал параграф со стилем Hide при нажатии на кнопку "Написать" стиль убирается и появляется текст "Комментарий отправляется..."
      commentPreloadEl.classList.value = "-loading";

      // Ошибка 400
      function fourHundredError() {
        alert("Имя или текст короче 3 символов");
        inputNameEl.classList.add("error");
        inputTextEl.classList.add("error");
        formEl.classList.value = "add-form";
        commentPreloadEl.classList.value = "hide";
      }

      // Ошибка когда что то пошло не так
      function somethingsWrong() {
        alert("Что то пошло не так, попробуйте пожалуйста позже");
        setTimeout(() => {
          formEl.classList.value = "add-form";
          commentPreloadEl.classList.value = "hide";
        }, 2500);
      }

      // Отправка данных на серевр v3.0

      function sendData() {
        fetch(baseURL, {
          method: "POST",
          body: JSON.stringify({
            text: goodByeHacker(inputTextEl.value),
            name: goodByeHacker(inputNameEl.value),
            forceError: true,
          }),
        })
          .then((response) => {
            if (response.status === 201) {
              return response.json();
            } else {
              throw (respStat = response.status);
            }
          })
          .then((responseData) => {
            return fetch(baseURL, {
              method: "GET",
            });
          })
          .then((response) => {
            return response.json();
          })
          .then((responseData) => {
            commentsForRender = responseData.comments;
            renderComments();
          })
          .then((Data) => {
            // Отображение формы
            formEl.classList.value = "add-form";
            commentPreloadEl.classList.value = "hide";
            // Очистка формы
            document.getElementById("inputName").value = "";
            document.getElementById("inputText").value = "";
            handleButtonClick();
          })
          .catch((respStat) => {
            if (respStat === 400) {
              return fourHundredError();
            }
            if (respStat === 500) {
              setTimeout(() => {
                sendData();
              }, 2500);
            } else {
              somethingsWrong();
            }
          });
      }
    });

    // Прокрутка документа после добавления комментария
    function handleButtonClick() {
      formEl.scrollIntoView({ block: "center", behavior: "smooth" });
    }
    // Убираем уязвимость
    function goodByeHacker(text) {
      return text
        .replaceAll("<", "&lt")
        .replaceAll(">", "&gt")
        .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
        .replaceAll("QUOTE_END", "</div>");
    }

    // Удаляем комменнтарий из массива
    dellbutton.addEventListener("click", function (e) {
      commentsForRender.pop();
      renderComments();
    });
  </script>
</html>
